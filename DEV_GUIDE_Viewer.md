# Dev Guide (Viewer) 

## Stack

- [bun](https://bun.sh/)
- [Vite](https://vite.dev/) + [React](https://react.dev/) + [react-router-v7](https://reactrouter.com/home) setup using `bun create vite@latest`
  - `react-router-v7` is configured with `ssr: false` so that the build output is a SPA rather than SSR/SSG - required by Tauri.
- [shadcn](https://ui.shadcn.com/) + [Tailwind CSS](https://tailwindcss.com/) setup using [Vite](https://ui.shadcn.com/docs/installation/vite)
- [Tauri](https://v2.tauri.app/) for the desktop app
- [zustand](https://zustand.docs.pmnd.rs/) for state management
- [immer](https://immerjs.github.io/immer/) for state updates
- [eslint](https://eslint.org/) and [prettier](https://prettier.io/) for linting and formatting

## Routes

Routes are setup the via the method in https://reactrouter.com/start/framework/routing in the [src/ui/app/routes.ts](src/ui/app/routes.ts) file.

We currently have routes for the following:
- Home: [src/ui/app/routes/home.tsx](src/ui/app/routes/home.tsx)
- Apps: [src/ui/app/routes/apps/index.tsx](src/ui/app/routes/apps/index.tsx)
    - App: [src/ui/app/routes/apps/[id].tsx](src/ui/app/routes/apps/[id].tsx)
- Tags: [src/ui/app/routes/tags/index.tsx](src/ui/app/routes/tags/index.tsx)
    - Tag: [src/ui/app/routes/tags/[id].tsx](src/ui/app/routes/tags/[id].tsx)
- Alerts: [src/ui/app/routes/alerts/index.tsx](src/ui/app/routes/alerts/index.tsx)
    - Alert: [src/ui/app/routes/alerts/[id].tsx](src/ui/app/routes/alerts/[id].tsx)
- History: [src/ui/app/routes/history.tsx](src/ui/app/routes/history.tsx)
- Experiments (only in `dev`): [src/ui/app/routes/experiments.tsx](src/ui/app/routes/experiments.tsx)
- Settings: [src/ui/app/routes/settings.tsx](src/ui/app/routes/settings.tsx)

## State

We use `zustand` to manage state in [src/ui/app/lib/state.ts](src/ui/app/lib/state.ts). The store can be used via the `useAppState` hook.

The store can be refreshed using `refresh()`, but must be initialized via `initState()` first. Note that this function also initializes the corresponding state on the Tauri Rust side.

It's possible for the state to be out-of-date with the database since new `App`s can be created via opening them for the first time, by the Engine. 
Thus, queries that return this `App` id (e.g. `getAppDurations`) will not find a corresponding `App` in the state. Use `useRefresh()`'s `handleStaleXxx`
functions to handle this case. Functions that rely on `useAppState(state => state.Xxx)` just need to use `handleStaleXxx` and use that in their
`useEffect` dependencies.

`useRefresh()` also provides a `refreshToken` otherwise, usually used when we interface with the Tauri Rust side. e.g.:
```ts
useEffect(() => {
    getAppDurations(/**/).then(setUsages);
}, [refreshToken, /**/]);
```

## Bindings

We call the Rust side via bindings generated by Tauri, based on Tauri commands ([guide](https://v2.tauri.app/develop/calling-rust/)). The commands are registered in [src/ui/src-tauri/src/lib.rs](src/ui/src-tauri/src/lib.rs).

All output must be `Serializable`. Fallibility is handled by the `AppResult` type, and the error is passed to the UI.